name: Auto Build & Commit Firmware

on:
  schedule:
    - cron: '0 3 * * *'  # 每天檢查一次
  push:
    paths:
      - '*.yaml'
      - '.github/workflows/**'
    branches:
      - main  # 確認您的分支名稱
  workflow_dispatch:

permissions:
  contents: write  # 重要：必須有寫入權限才能 Commit 回去

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # 使用預設 Token

      # --- 1. 版本檢查邏輯 (選用，不檢查也行，反正沒變更 Commit 會是空的) ---
      - name: Check ESPHome Version
        id: check_version
        run: |
          LATEST_VERSION=$(curl -s https://registry.hub.docker.com/v2/repositories/esphome/esphome/tags/stable | jq -r '.name' || echo "unknown")
          echo "Latest version: $LATEST_VERSION"
          
          if [ -f .last_build_version ]; then
            LAST_BUILD=$(cat .last_build_version)
          else
            LAST_BUILD="none"
          fi
          
          # 若是 Schedule 觸發且版本相同，則跳過
          if [ "$LATEST_VERSION" == "$LAST_BUILD" ] && [ "${{ github.event_name }}" == "schedule" ]; then
             echo "should_build=false" >> $GITHUB_OUTPUT
             echo "Already up to date."
          else
             echo "should_build=true" >> $GITHUB_OUTPUT
             echo "New version detected or manual trigger."
          fi
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      # --- 2. 準備環境 & 編譯 ---
      - name: Create secrets.yaml
        if: steps.check_version.outputs.should_build == 'true'
        run: echo "${{ secrets.ESPHOME_SECRETS_YAML }}" > secrets.yaml

      - name: Build Sonoff S31 Firmware
        if: steps.check_version.outputs.should_build == 'true'
        uses: esphome/build-action@v6
        id: esphome_build
        with:
          yaml-file: sonoff-s31.yaml
          version: latest

      # --- 3. 處理檔案 & 生成 MD5 ---
      - name: Process Artifacts
        if: steps.check_version.outputs.should_build == 'true'
        run: |
          # 從輸出目錄找 .ota.bin 搬到根目錄
          find ${{ steps.esphome_build.outputs.name }} -name "*.ota.bin" -exec mv {} ./sonoff-s31.bin \;
          
          # 生成 MD5
          md5sum sonoff-s31.bin | cut -d ' ' -f 1 > sonoff-s31.md5
          
          # 更新版本記錄檔
          echo "${{ steps.check_version.outputs.version }}" > .last_build_version
          
          # 刪除 secrets.yaml (以防不小心 commit)
          rm secrets.yaml

      # --- 4. Commit 回 Repo (核心步驟) ---
      - name: Commit and Push
        if: steps.check_version.outputs.should_build == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 強制加入二進制檔案 (即使 .gitignore 有忽略)
          git add -f sonoff-s31.bin sonoff-s31.md5 .last_build_version
          
          # 嘗試 Commit，如果沒有變更 (例如編譯結果完全一樣) 則不報錯
          # [skip ci] 很重要！防止這次 Commit 又觸發一次 Workflow 造成無限迴圈
          git commit -m "Auto-build firmware [skip ci]" || echo "No changes to commit"
          
          # 推送
          git push origin main
