name: Build and Update Latest Firmware

on:
  push:
    paths:
      - '*.yaml'          # 只有當 YAML 變更時才觸發
      - '.github/workflows/**'
    branches:
      - main              # 或 master，請確認您的主分支名稱

permissions:
  contents: write         # 給予 Action 寫入 Releases 的權限

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 還原 secrets.yaml
      - name: Create secrets.yaml
        run: |
          echo "${{ secrets.ESPHOME_SECRETS_YAML }}" > secrets.yaml

      # 2. 編譯 ESPHome 韌體
      - name: Build Sonoff S31 Firmware
        uses: esphome/build-action@v6
        id: esphome_build
        with:
          yaml-file: sonoff-s31.yaml   # 請替換成您的 YAML 檔名
          version: latest

      # 3. 重新命名檔案 (確保下載名稱固定)
      - name: Rename Artifact
        run: |
          # 進入 Action 生成的輸出目錄 (目錄名稱就是 outputs.name)
          cd ${{ steps.esphome_build.outputs.name }}
          
          # 顯示一下目錄內容，方便除錯 (可選)
          ls -la
          
          # 尋找並移動 OTA 專用的 bin 檔
          # 注意：v6 版通常會生成 'sonoff-s31.ota.bin' 或類似名稱
          # 我們直接把找到的第一個 .bin 搬出來改名
          find . -name "firmware.bin" -print0 | xargs -0 -I {} mv {} ../sonoff-s31.bin
          
          # 回到上一層目錄
          cd ..
          
          # 生成 MD5
          md5sum sonoff-s31.bin | cut -d ' ' -f 1 > sonoff-s31.md5

      # 4. 發布/更新 Release (核心步驟)
      - name: Update Latest Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "sonoff-s31.bin,sonoff-s31.md5"
          tag: "latest"                # 固定 Tag 名稱
          name: "Latest Firmware Build"
          body: "Auto-generated build from ${{ github.sha }}"
          allowUpdates: true           # 允許更新已存在的 Release
          replacesArtifacts: true      # 允許覆蓋舊的 .bin 檔案
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
